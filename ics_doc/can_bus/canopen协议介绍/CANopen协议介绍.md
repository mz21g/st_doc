---
typora-root-url: ./
---

# CANopen协议介绍

- CANopen协议的发展
- ISO结构
- 报文ID分类
- 对象字典OD
- 网络管理NMT与CANopen主站
- 过程数据对象PDO
- 服务数据对象SDO
- 特殊协议

## CANopen协议的发展

CANopen 协议是在 20 世纪 90 年代末，由总部位于德国纽伦堡的 CiA 组织——CAN-in-Automation在 CAL（CAN Application Layer）的基础上发展而来。  

CiA 组织对于CANopen 协议坚持开放、免费、非盈利的原则。时至今日已经成为全世界最为流行的 CAN应用层协议。

 CiA 在 CANopen 基础协议——CiA 301 之上，对各个行业不断推出设备子协议 ，  子协议，就是针对不同行业的应用对象，对 CANopen 内部的数据含义进行重新定义，或者添加新的控制逻辑  

目前形成的CANopen 子协议：
 CiA 421 series: Train vehicle control system 列车车辆控制系统
 CiA 423 series: Diesel engine control system 柴油机控制系统
 CiA 424 series: Door control system 门控制系统
 CiA 426 series: Exterior light control system 外部灯控制系统
 CiA 430 series: Auxiliary equipment control system 辅助设备控制系统  

## ISO结构



![image-20200508095250949](/images/CANopen协议介绍/image-20200508095250949.png)

## CANopen的预定义报文分类

报文规定：

- 报文传输采用 CAN 标准帧格式。即 11bit 的 ID 域，以尽量减小传输时间；  

  ![image-20200508100925062](/images/CANopen协议介绍/image-20200508100925062.png)

- 网络控制报文均采用数据最小字节数。比如心跳报文，只有 1 个字节数据；  

- 需要接收方确认的配置参数一般都是采用快速单字传输。即 1 个报文最多传送 1个 32 字节的参数变量，避免了分帧引起的实时性降低  

### 网络管理（NMT） 与特殊协议（Special protocols） 报文 ID 分类  

虽然 CANopen 的通讯发挥了 CAN 的特色，所有节点通信地位平等， 运行时允许自行发送报文，但 CANopen 网络为了稳定可靠可控，都需要设置一个网络管理主机 NMT-Master
（Network Management-Master）  

NMT 主机一般是 CANopen 网络中具备监控的 PLC 或者 PC（当然也可以是一般的功能节点）， 所以也称为CANopen主站。相对应的其他 CANopen节点就是 NMT从机(NMT-slaves)。  

NMT 主机和 NMT 从机之间通讯的报文就称为 NMT 网络管理报文。管理报文负责层管理、网络管理和 ID 分配服务。例如，初始化、配置和网络管理（其中包括节点保护）。网络管理中，同一个网络中只允许有一个主节点、一个或多个从节点，并遵循主从模式。  

为了协调各个节点的**同步、心跳、时间、错误提示**等通讯控制， CANopen 定义了一系列特殊协议（Special protocols）报文  

![image-20200508101717265](/images/CANopen协议介绍/image-20200508101717265.png)

### 过程数据对象（PDO）和服务数据对象（SDO） 的报文 ID 分类  

用户应用 CANopen 时，需要传递的配置信息和应用信息都是放在过程数据对象 PDO（Process data object） 和服务数据对象 SDO (Service data object)里面  。

**PDO 属于过程数据，即单向传输，无需接收节点回应CAN 报文来确认，从通讯术语上来说是属于“生产消费”模型。**  

**SDO 属于服务数据，有指定被接收节点的地址（Node-ID），并且需要指定的接收节点回应 CAN 报文来确认已经接收， 如果超时没有确认，则发送节点将会重新发送原报文。这种通讯方式属于常见的“服务器客户端”的通信模型，即我们通常所说的轮询式。**  

对于 PDO 和 SDO 的报文 ID 分配，为了减少网络的组态工作量， CANopen 预定义了强制性的缺省标识符（CAN-ID）分配表，该分配表是基于 11 位 CAN-ID 的标准帧格式。 **将其划分为 4 位的功能码（Function-ID） 和 7 位的节点号（Node-ID）**。  

![image-20200508102728424](/images/CANopen协议介绍/image-20200508102728424.png)

由于需要区分每个 CANopen 节点的输入和输出，所以 **PDO 分为 TPDO（发送 PDO）和RPDO(接收PDO)，发送和接收是以 CANopen 从站节点为参考**（如果 CAN 主站就相反）。**TPDO**
**和 RPDO 分别有 4 个数据对象，每种数据对象就是 1 条 CAN 报文封装。**

SDO 就相对比较简单固定， **发起通讯的“问”SDO 的 CAN 帧 ID 就是 600h +node-ID，这里的 Node-ID 是被问的节点地址，而被问的节点应“答” SDO 的 CAN 帧 ID 就是 580h+node-ID。**一般在 CANopen 网络中，只有 NMT 主机能发起 SDO 通讯，进行节点参数配置或者关键性参数的传递。当然从节点也可以对其他从节点发起 SDO 通讯。    

![image-20200508103650150](/images/CANopen协议介绍/image-20200508103650150.png)

## 对象字典 OD（Object dictionary)  

CANopen 对象字典（OD: Object Dictionary） 是 CANopen 协议最为核心的概念。所谓的对象字典就是一个有序的对象组， 描述了对应 CANopen 节点的所有参数，包括通讯数据的存放位置也列入其索引， **这个表变成可以传递形式就叫做 EDS 文件（电子数据文档**
**Electronic Data Sheet）** 。  

每个对象采用一个 16 位的索引值来寻址，这个**索引值通常被称为索引，其范围在 0x0000到 0xFFFF 之间。 为了避免数据大量时无索引可分配，所以在某些索引下也定义了一个 8 位的索引值，这个索引值通常被称为子索引，其范围是 0x00 到 0xFF之间。**
**每个索引内具体的参数，最大用 32 位的变量来表示，即Unsigned32，四个字节。****  

CANopen 对象字典中的项由一系列子协议来描述。子协议为对象字典中的每个对象都描述了它的功能、名字、索引、子索引、数据类型，以及这个对象是否必需、读写属性等等，这样可保证不同厂商的同类型设备兼容。  

### 对象字典概述  

下表为对象字典索引区域定义， 其中标绿色底纹的**通讯对象子协议区和制造商特定子协议**区是需要关注的区域  

![image-20200508104853932](/images/CANopen协议介绍/image-20200508104853932.png)

### 通讯对象子协议区（Communication profile area）  

通讯对象子协议区（Communication profile area）定义了所有和通信有关的对象参数，如表 5.2 所示， **标绿色底纹的索引范围 1000h to 1029h为通用通讯对象，所有 CANopen 节点都必须具备这些索引，否则将无法加入 CANopen 网络**。其他索引根据实际情况进行分配与定义。  

![image-20200508105445737](/images/CANopen协议介绍/image-20200508105445737.png)

### 通用通讯对象（General communication objects）  

由于通用通讯对象十分重要， NMT 主站（CANopen 主站） 在启动时， 通常都全部或者部分读取所有从站中通用通讯对象中的索引， 所以所有的通用通讯对象都必须在CANopen 从站中实现

![image-20200508105608884](/images/CANopen协议介绍/image-20200508105608884.png)

![image-20200508105637362](/images/CANopen协议介绍/image-20200508105637362.png)

![image-20200508105709577](/images/CANopen协议介绍/image-20200508105709577.png)

### 制造商特定子协议（Manufacturer-specific Profile）  

对象字典索引 2000h to 5FFFh为制造商特定子协议， 通常是存放**所应用子协议的应用数据**。而通讯对象子协议区（Communication profile area）是存放这些应用数据的通信参数。
 RPDO 的通讯参数存放在 1400h to 15FFh 映射参数存放在 1600h to 17FFh 数据存放为2000h 之后厂商自定义区；
 TPDO 的通讯参数存放在 1800h to 19FFh 映射参数存放在 1A00h to 1BFFh 数据存放为2000h 之后厂商自定义区。  

### 标准化设备子协议(Standardized profile area)  

标准化设备子协议，为各种行业不同类型的标准设备定义对象字典中的对象。目前已有十几种为不同类型的设备定义的子协议，例如 DS401、 DS402、 DS406 等，其索引值范围为 0x6000～0x9FFF。 这个区域对于不同的标准化设备子协议来说，相同的对象字典项其定义不一定相同。  

### 对象字典和 EDS 文件实例  

对于对象字典和 EDS 文件的实现，需要使用专用的 EDS 生成工具  ，如图 5.2 所示，为 XGate-COP10 的 EDS 文件导入到 USBCAN-E-P 主站卡管理软件CANManager for CANopen 中。配置从站框中观察到 的XGate-COP10 的对象字典内容

![image-20200508110447459](/images/CANopen协议介绍/image-20200508110447459.png)

EDS文件的索引内容

![image-20200508110546980](/images/CANopen协议介绍/image-20200508110546980.png)

## 网络管理 NMT（Network management) 与 CANopen 主站  

每个 CANopen 从节点的 CANopen 协议栈中，必须具备 NMT 管理的相应代码，这是节点具备 CANopen 协议的最基本的要素。

### NMT 节点状态    

NMT 管理涉及到一个 CANopen 节点从上电开始的 6 钟状态，包括：
 **初始化**（Initializing）：节点上电后对功能部件包括 CAN 控制器进行初始化；
 **应用层复位**（Application Reset）：节点中的应用程序复位（开始），比如开关量输出、模拟量输出的初始值；
 **通讯复位**（Communication reset）：节点中的CANopen通讯复位（开始），从这个时刻起，此节点就可以进行CANopen通讯了。
 **预操作状态**（Pre-operational）：节点的CANopen通讯处于操作就绪状态，此时此节点不能进行PDO通信，而可以进行SDO进行参数配置和NMT网络管理的操作；
 **操作状态**（operational）：节点收到NMT主机发来的启动命令后， CANopen通讯被激活， PDO通信启动后， 按照对象字典里面规定的规则进行传输，同样SDO也可以对节点进行数据传输和参数修改；
 **停止状态**（Stopped）： 节点收到NMT主机发来的停止命令后，节点的PDO通信被停止，但SDO和NMT网络管理依然可以对节点进行操作；  

除了初始化状态， NMT主机通过NMT命令可以让网络中任意一个的CANopen节点进行其他5种状态的切换。当然CANopen节点也可以程序自动完成这些状态的切换。  

### NMT 节点上线报文  

任何一个 CANopen 从站上线后，为了提示主站它已经加入网络（便于热插拔），或者避免与其他从站 Node-ID 冲突。这个从站必须发出节点上线报文（boot-up），如图 6.3 所示，节点上线报文的 **ID 为 700h+Node-ID， 数据为 1 个字节 0**。 生产者为 CANopen 从站。  

![image-20200508111336498](/images/CANopen协议介绍/image-20200508111336498.png)

### NMT 节点状态与心跳报文  

为了监控 CANopen 节点是否在线与目前的节点状态。 CANopen 应用中通常都要求在线上电的从站定时发送状态报文（心跳报文），以便于主站确认从站是否故障、是否脱离网络。
如图 6.4所示，为心跳报文发送的格式， CANID 与节点上线报文相同为**700h+Node-ID，数据为 1 个字节，代表节点目前的状态，04h为停止状态， 05h为操作状态， 7Fh为预操作状态**。  

![image-20200508111624682](/images/CANopen协议介绍/image-20200508111624682.png)

CANopen 从站按其对象字典中 1017h 中填写的心跳生产时间（ms）进行心跳报文的发送，而 CANopen 主站（NMT 主站）则会按其 1016h 中填写的心跳消费时间进行检查，假设超过诺干次心跳消费时间没有收到从站的心跳报文，则认为从站已经离线或者损坏。  

### NMT 节点状态切换命令  

**NMT 网络管理中，最核心的就是 NMT 节点状态切换命令**，这是 NMT 主站所进行网络管理的“命令”报文。 
**CANID 均为 000h，具备最高的 CAN 优先级。数据为 2 个字节**：
 **第 1 个字节代表命令类型**：
**01h**为启动命令（让节点进入操作状态）；
**02h**为停止命令（让节点进入停止状态）；
**80h**为进入预操作状态（让节点进入预操作状态）；
**81h**为复位节点应用层（让节点的应用恢复初始状态，比如列车门都恢复打开状态）；
**82h**为复位节点通讯（让节点的 CAN 和 CANopen 通讯重新初始化，一般用于总线收到干扰，导致节点总线错误被动，或者总线关闭时）。
 **第二个字节代表被控制的节点 Node-ID，**
**如果要对整个网络所有节点同时进行控制，则这个数值为 0 即可**。  

![image-20200508112055901](/images/CANopen协议介绍/image-20200508112055901.png)

### CANopen 主站设备  

通常 NMT 主站也称为 CANoepn 主站， 上文所述为 CANopen 最基本的 NMT 操作，而作为一个完整的 CANopen 主站设备，设备模型如图 6.6 所示。为了满足管理整个 CANopen网络的从站设备，需要具备以下功能：  

 支持 PDO、 SDO 发送与接收；
 支持 NMT 网络管理；
 支持 PDO 通信类型并能够支持监控每一个 PDO 目标；
 LSS 层设置功能：**从站波特率设置、从站节点编号设置（主站启动时的命令是哪来的）**；
 支持从站管理功能：类型与名称读取、对象字典读写；
 紧急报文发送功能；
 扩展 CANopen 标准指示灯功能  

![image-20200508112929331](/images/CANopen协议介绍/image-20200508112929331.png)

目前有二种形式的主站，一种是可编程控制器（PLC） 中的一个单元，它的内部集成了CANopen 的主站功能，这个单元能连接到 CANopen 总线，同时因为它是 PLC 中的一个单元，它能与 PLC 的 CPU 交换数据，因此通过编写 PLC 程序对它所连接的 CANopen 从站进行管理和控制。  

另一种是通过 PC 扩展一个 CANopen 主站通信卡，从而令 PC 具有管理 CANopen 通信网络的能力。  

## 过程数据对象 PDO（Process data object)  

单向传输，无需接收节点回应CAN 报文来确认，数据长度被限制为 1~8 字节。最多只要 1 帧就可以把一条信息或者一个变量传递结束  。

### PDO 的 CAN-ID 定义  

PDO 通信比较灵活，广义上只要符合 PDO 范围内的所有 CANID 都可以作为节点自身的 TPDO 或者 RPDO 使用，也称为 COB-ID，不受功能码和 Node-ID 限制。

而在 PDO 预定义中，人为规定了 TPDO 和 RPDO，规定了 Node-ID 在 PDO 中的位置，规定了 PDO 的编号，如表 7.1 所示。  

![image-20200508125056144](/images/CANopen协议介绍/image-20200508125056144.png)

如果某个节点需要传递的资源特别多，则有出现例如 TPDO5 之类的数据对象，而它们的 CAN-ID 定义就需要打破预定义的规则，比如我们可以定义 Node-ID 为 1 的节点中 TPDO5 是 182h，这里的 PDO 的 COB-ID 中的低 7 位不再是表示 Node-ID。  

### PDO 的传输形式  

 **异步传输（由特定事件触发）**
其触发方式可有两种， 第一种是由设备子协议中规定的对象特定事件来触发（例如，定时传输，数据变化传输等）。第二种是通过发送与 PDO 的 COB-ID 相同的远程帧来触发 PDO的发送。 **目前应用中的异步传输基本都采用第一种。**
 **同步传输（通过接收同步对象实现同步）**
**同步传输就是通过同步报文让所有节点能在同一时刻进行上传数据或者执行下达的应用指令**，可以有效避免异步传输导致的应用逻辑混乱和总线负载不平衡的问题。 一般发送同步报文的节点是 NMT 主机。  

同步传输又可分为周期传输（循环）和非周期传输（无循环） 。 周期传输则是通过接收  同步对象（SYNC）来实现，可以设置 1~240 个同步对象触发。 非周期传输是由远程帧预触发或者由设备子协议中规定的对象特定事件预触发传送。  

### PDO 的通信参数  

PDO 通信参数，定义了该设备所使用的 COB-ID、传输类型、定时周期等。 RPDO 通讯参数位于对象字典索引的 1400h to 15FFh， TPDO 通讯参数位于对象字典索引的 1800h to19FFh。 每条索引代表一个 PDO 的通信参数集，其中的子索引分别指向具体的各种参数。如表 7.2 所示  

![image-20200508125516416](/images/CANopen协议介绍/image-20200508125516416.png)

 **Number of entries 参数条目数量**：即本索引中有几条参数；
 **COB-ID**：即这个 PDO 发出或者接收的对应 CAN 帧 ID；
 **发送类型**：即这个 PDO 发送或者接收的传输形式，通常使用循环同步和异步制造
商特定事件较多；
 **Inhibit time 生产禁止约束时间(1/10ms)**：约束 PDO 发送的最小间隔，避免导致总
线负载剧烈增加，比如数字量输入过快，导致状态改变发送的 TPDO 频繁发送，
总线负载加大，所以需要一个约束时间来进行“滤波”，这个时间单位为 0.1ms；
 **Event timer 事件定时器触发的时间(单位 ms)**：定时发送的 PDO，它的定时时间，
如果这个时间为 0，则这个 PDO 为事件改变发送。
 **SYNC start value 同步起始值**：同步传输的 PDO，收到诺干个同步包后，才进行发
送，这个同步起始值就是同步包数量。比如设置为 2，即收到 2 个同步包后才进行
发送。  

### PDO 的映射参数  

**PDO 映射参数是初学者学习 CANopen 时的一个难点**， 它包含了一个对象字典中的对象列表，这些对象映射到相应的 PDO，其中包括数据的长度（单位，位），对于生产者和消费者都必须要知道这个映射参数，才能够正确的解释 PDO 内容。 就是**将通信参数、应用数据和具体 CAN 报文中数据联系起来**。

RPDO 通讯参数 1400h to 15FFh， 映射参数 1600h to 17FFh， 数据存放为 2000h 之后厂商自定义区域； TPDO 通讯参数 1800h to 19FFh， 映射参数 1A00h to 1BFFh， 数据存放为 2000h 之后厂商自定义区域。  

为了更加直观地表现映射， 表 7.3 模拟 TPDO1，将参数、应用数据、 CAN 报文数据联合起来展示，不同的映射采用不同的颜色。  

![image-20200508125746098](/images/CANopen协议介绍/image-20200508125746098.png)

![image-20200508125806591](/images/CANopen协议介绍/image-20200508125806591.png)

CAN transmission( CAN 发送报文)
TPDO1（CAN-ID = 181h） Data field：数据域 4 个字节  

![image-20200508125901087](/images/CANopen协议介绍/image-20200508125901087.png)

## 服务数据对象 SDO（Service data object）  

SDO 主要用于 CANopen 主站对从节点的参数配置。 **服务确认是 SDO 的最大的特点，为每个消息都生成一个应答，确保数据传输的准确性**。  类似于收快递。

在一个 CANopen 系统中，**通常 CANopen 从节点作为 SDO 服务器， CANopen 主节点作为客户端（称为 CS 通讯）**。 SDO 客户端通过索引和子索引，能够访问 SDO 服务器上的对象字典。这样 CANopen 主节点可以访问从节点的任意对象字典项的参数，并且 SDO 也可以传输任何长度的数据（当数据长度超过 4 个字节时就拆分成多个报文来传输）。   

### 通讯原则（communication principle）  

SDO 的通讯原则非常单一， **发送方（客户端）发送 CAN-ID 为 600h+Node-ID 的报文，其中 Node-ID 为接收方（服务器）的节点地址，数据长度均为 8 字节**；  

**接收方（服务器）成功接收后，回应 CAN-ID 为 580h+Node-ID 的报文。 这里的 Node-ID依然是接收方（服务器）的节点地址， 数据长度均为 8 字节**。 如图 8.2 所示。  

![image-20200508130319019](/images/CANopen协议介绍/image-20200508130319019.png)

### 快速 SDO 协议（Expedited SDO protocol）  

最常见的 SDO 协议是快速 SDO，**所谓快速，就是 1 次来回就搞定。 前提是读取和写入的值不能大于 32 位**。如图 8.3 所示，为快速 SDO 协议的示意图。 命令中直接包含了要读写的**索引、 子索引、数据**。  

![image-20200508130624947](/images/CANopen协议介绍/image-20200508130624947.png)

通过快速 SDO，可以直接对 CANopen 节点的对象字典中的值进行读取和修改， 所以在做参数配置之外，也经常作为关键性数据传输之用。  

### 普通 SDO 协议（Normal SDO protocol）  

当需要传输的值超过 32 位时，就不能使用快速 SDO 传输。必须使用普通 SDO 进行分帧传输。在应用中较少用到。一般用于 CANopen 节点的程序固件升级，或者做网关转换MVB 总线之类数据最大可达 256 位的应用。  

### 例子

![image-20200508133426094](/images/CANopen协议介绍/image-20200508133426094.png)

第一句是主站读从站的Index 1000，即Device Type
第二句是从站回复给主站的数据

## 特殊协议（Special protocols）  

为了方便 CANopen 主站对从站管理。在 CANopen 协议中，已经为特殊的功能预定义了 COB-ID，其主要有以下几种特殊报文。  

### 同步协议（Sync protocol）  

同步（SYNC），该报文对象主要实现整个网络的同步传输，每个节点都以该同步报文作为 PDO 触发参数，因此该同步报文的 COB-ID 具有比较高的优先级以及最短的传输时间。**一般选用 80h作为同步报文的 CAN-ID**。  

![image-20200508131449615](/images/CANopen协议介绍/image-20200508131449615.png)

一般同步报文由 NMT 主机发出， CAN 报文的数据为 0 字节。但如果一个网络内有 2个同步机制，就需要设置不同的同步节拍，比如某些节点按 1 个同步帧发送 1 次 PDO，其他的节点收到2个同步帧才发送1此PDO，所以这里PDO参数中的同步起始值就起了作用。

在同步协议中，有 2 个约束条件：
 **同步窗口时间**： 索引 1007h约束了同步帧发送后，从节点发送 PDO 的时效，即在这个时间内发送的 PDO 才有效，超过时间的 PDO 将被丢弃；
 **通讯循环周期**： 索引 1006h规定了同步帧的循环周期。  

### 时间戳协议（Time-stamp protocol）  

时间标记对象（Time Stamp），NMT 主机发送自身的时钟，为网络各个节点提供公共的时间参考，即网络对时，通常用于故障诊断。  

时间戳协议采用广播方式，无需节点应答， **CAN-ID 为 100h，数据长度为 6，数据为当前时刻与 1984 年 1 月 1 日 0 时的时间差**。  

### 紧急报文协议（Emergency protocol）  

紧急事件对象（Emergency）， 是当设备内部发生错误，触发该对象， **发送设备内部错误代码，提示 NMT 主站**。 紧急报文属于诊断性报文，一般不会影响 CANopen 通讯， **其 CAN-ID存储在 1014h的索引中，一般会定义为 080h +node-ID，数据包含 8 个字节**， 如图 9.5 所示。  

![image-20200508132114610](/images/CANopen协议介绍/image-20200508132114610.png)

其中包括 EEC：紧急时间错误代码， ER：错误寄存器， MEF：厂商自定义的错误代码。当然这些都需要查表才能获知，进行诊断。  

![image-20200508132314667](/images/CANopen协议介绍/image-20200508132314667.png)

与 PDO 的生产禁止时间类似，紧急报文也有生产禁止时间，存储在对象字典的 1015h中，为了限制节点不断发送紧急报文，导致总线负载过大。  

# 参考文献

1.《CANopen简单入门》

2.http://www.dndev.com/cgi-bin/forum/topic.cgi?forum=2&topic=103